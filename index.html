<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Node Final</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --wa-green: #00a884; --dark: #0b141a; --header: #202c33; --my: #005c4b; --fr: #202c33; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            height: 100%; width: 100%; position: fixed;
            background: var(--dark); color: #fff; font-family: 'Segoe UI', sans-serif;
            background-image: url('https://i.imgur.com/vHqPjT3.jpeg'); 
            background-size: cover; background-position: center; background-blend-mode: overlay;
        }

        #login { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #app, #flag-page { display: none; flex-direction: column; height: 100%; width: 100%; max-width: 500px; margin: 0 auto; background: rgba(11,20,26,0.9); border-radius: 10px; overflow-y: auto; }

        /* Flag Page Styling */
        #flag-page { padding: 30px; text-align: center; }
        .flag-box { width: 200px; height: 120px; background: #006a4e; margin: 0 auto 20px; border-radius: 5px; position: relative; display: flex; align-items: center; justify-content: center; }
        .circle { width: 60px; height: 60px; background: #f42a41; border-radius: 50%; }

        header { background: var(--header); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 80px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .my { align-self: flex-end; background: var(--my); border-bottom-right-radius: 2px; }
        .fr { align-self: flex-start; background: var(--fr); border-bottom-left-radius: 2px; }

        .input-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; background: var(--header); padding: 10px; display: flex; align-items: center; gap: 8px; z-index: 200; }
        input#m-in { flex: 1; background: #2a3942; border: none; border-radius: 25px; padding: 12px 18px; color: #fff; font-size: 16px; }
        .circle-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: var(--wa-green); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; flex-shrink: 0; }
        
        #call-ui { position: fixed; inset: 0; background: #0b141a; z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .end-call { background: #ea4335; border: none; padding: 15px 40px; border-radius: 30px; color: white; font-weight: bold; margin-top: 50px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login">
    <h3 style="margin-bottom:20px; color:var(--wa-green);">Security Check</h3>
    <input type="password" id="pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" style="padding:15px; border-radius:10px; border:none; width:220px; text-align:center; background:#2a3942; color:#fff;">
    <button onclick="auth()" class="circle-btn" style="width:auto; padding:0 30px; border-radius:10px; margin-top:15px; font-size:16px;">Verify</button>
</div>

<div id="app">
    <header>
        <div><b style="color:var(--wa-green);">Private Hub</b><div id="p-status" style="font-size:10px; color:#8696a0;">Initializing...</div></div>
        <button onclick="makeCall()" style="background:none; border:none; font-size:24px; cursor:pointer;">ðŸ“ž</button>
    </header>
    <div style="padding:10px; display:flex; gap:5px; background:rgba(0,0,0,0.3);">
        <input type="text" id="fid" placeholder="Friend's ID" style="padding:10px; border-radius:5px; flex:1; background:#111b21; border:none; color:#fff; font-size:13px;">
        <button onclick="link()" style="background:var(--wa-green); border:none; padding:0 15px; border-radius:5px; color:#fff; font-size:13px; font-weight:bold;">Link</button>
    </div>
    <div id="chat-box"></div>
    <div class="input-bar">
        <button id="v-btn" class="circle-btn" style="background:#54656f;">ðŸŽ¤</button>
        <input type="text" id="m-in" placeholder="Message..." autocomplete="off">
        <button onclick="send()" class="circle-btn">ðŸš€</button>
    </div>
</div>

<div id="flag-page">
    <h2 style="color: var(--wa-green); margin-bottom: 20px;">Our National Flag</h2>
    <div class="flag-box"><div class="circle"></div></div>
    <p style="line-height: 1.6; text-align: justify; color: #cfd8dc;">
        The national flag of Bangladesh is the symbol of our independence and sovereignty. It consists of a red circle in the middle of a bottle green rectangular background. The green color represents the lush greenery of our country, while the red circle symbolizes the rising sun and the blood shed by our martyrs in the Liberation War of 1971. We feel very proud of our national flag. It inspires us to love our country and work for its progress.
    </p>
    <button onclick="location.reload()" style="margin-top: 30px; background: #2a3942; border: none; padding: 10px 20px; color: white; border-radius: 5px; cursor: pointer;">Go Back</button>
</div>

<div id="call-ui">
    <div style="width:120px; height:120px; background:var(--wa-green); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:50px;">ðŸ‘¤</div>
    <h2 id="call-info" style="margin-top:20px;">Calling...</h2>
    <button onclick="hangup()" class="end-call">End Call</button>
</div>

<script>
    let peer, conn, lStream, mediaRec, chunks = [], activeCall;
    const ring = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3');

    // Authentication Logic
    function auth() {
        const val = document.getElementById('pw').value;
        if(val === "1234") {
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            init(); // Start PeerJS for Chat
        } else if(val === "4321") {
            document.getElementById('login').style.display = 'none';
            document.getElementById('flag-page').style.display = 'flex';
        } else {
            alert("Wrong Password!");
        }
    }

    // --- Original Chat Functions (PeerJS) ---
    function init() {
        let id = localStorage.getItem('s_pid') || Math.random().toString(36).substring(2,6).toUpperCase();
        localStorage.setItem('s_pid', id);
        peer = new Peer(id);
        peer.on('open', (myId) => {
            document.getElementById('p-status').innerText = "My ID: " + myId;
            let last = localStorage.getItem('last_f');
            if(last) { document.getElementById('fid').value = last; link(); }
        });
        peer.on('connection', c => { conn = c; handleConn(); });
        peer.on('call', call => {
            ring.play();
            if(confirm("Answer Incoming Call?")) {
                ring.pause();
                navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                    activeCall = call; lStream = s;
                    document.getElementById('call-ui').style.display = 'flex';
                    call.answer(s);
                    call.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
                    call.on('close', () => hangupUI());
                });
            } else { ring.pause(); }
        });
    }

    function link() {
        let tid = document.getElementById('fid').value.toUpperCase();
        if(tid) { localStorage.setItem('last_f', tid); conn = peer.connect(tid); handleConn(); }
    }

    function handleConn() {
        conn.on('open', () => { document.getElementById('p-status').innerText = "Connected âœ…"; });
        conn.on('data', d => {
            if(d.v) addAudio(d.v, 'fr');
            else addMsg(d, 'fr');
        });
        conn.on('close', () => { document.getElementById('p-status').innerText = "Disconnected âŒ"; });
    }

    function send() {
        let i = document.getElementById('m-in');
        if(conn && conn.open && i.value) {
            conn.send(i.value);
            addMsg(i.value, 'my');
            i.value = "";
        }
    }

    // --- Mic Logic ---
    const vBtn = document.getElementById('v-btn');
    if(vBtn) {
        ['mousedown', 'touchstart'].forEach(e => vBtn.addEventListener(e, (ev) => { ev.preventDefault(); startV(); }));
        ['mouseup', 'touchend'].forEach(e => vBtn.addEventListener(e, (ev) => { ev.preventDefault(); stopV(); }));
    }

    async function startV() {
        try {
            lStream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec = new MediaRecorder(lStream);
            chunks = [];
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.start();
            vBtn.style.background = "#ea4335";
        } catch(e) { alert("Mic required!"); }
    }

    function stopV() {
        if(!mediaRec || mediaRec.state === "inactive") return;
        mediaRec.stop();
        vBtn.style.background = "#54656f";
        mediaRec.onstop = () => {
            const blob = new Blob(chunks, {type: 'audio/webm'});
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                if(conn && conn.open) {
                    conn.send({v: reader.result});
                    addAudio(reader.result, 'my');
                }
            };
            lStream.getTracks().forEach(t => t.stop());
        };
    }

    function makeCall() {
        let tid = document.getElementById('fid').value.toUpperCase();
        navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
            lStream = s;
            activeCall = peer.call(tid, s);
            document.getElementById('call-ui').style.display = 'flex';
            activeCall.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
            activeCall.on('close', () => hangupUI());
        });
    }

    function hangup() {
        if(activeCall) activeCall.close();
        if(lStream) lStream.getTracks().forEach(t => t.stop());
        ring.pause();
        hangupUI();
    }

    function hangupUI() { document.getElementById('call-ui').style.display = 'none'; }

    function addMsg(m, c) {
        let d = document.createElement('div'); d.className = `msg ${c}`; d.innerText = m;
        const cb = document.getElementById('chat-box');
        cb.appendChild(d); cb.scrollTop = cb.scrollHeight;
    }

    function addAudio(b, c) {
        let d = document.createElement('div'); d.className = `msg ${c}`;
        let a = document.createElement('audio'); a.controls = true; a.src = b; a.style.width = "200px";
        d.appendChild(a);
        const cb = document.getElementById('chat-box');
        cb.appendChild(d); cb.scrollTop = cb.scrollHeight;
    }
</script>
</body>
</html>
