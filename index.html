<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Node v2</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --wa-green: #00a884; --dark: #0b141a; --header: #202c33; --my: #005c4b; --fr: #202c33; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body, html { 
            height: 100%; width: 100%; overflow: hidden;
            background-color: var(--dark);
            color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶á‡¶Æ‡ßá‡¶ú ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ */
            background-image: url('https://i.imgur.com/vHqPjT3.jpeg'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-blend-mode: overlay;
        }

        /* ‡¶™‡¶ø‡¶∏‡¶ø ‡¶ì ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶≤‡¶ø ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        #main-wrapper {
            height: 100%; width: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        #login, #app, #flag-page { 
            width: 100%; max-width: 450px; height: 100%; 
            background: rgba(11, 20, 26, 0.92); 
            display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #login { justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #app, #flag-page { display: none; }

        /* input styling to prevent auto-zoom on iOS */
        input { font-size: 16px !important; }

        header { background: var(--header); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; word-wrap: break-word; font-size: 15px; }
        .my { align-self: flex-end; background: var(--my); }
        .fr { align-self: flex-start; background: var(--fr); }

        .input-bar { background: var(--header); padding: 10px; display: flex; gap: 8px; align-items: center; }
        #m-in { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 20px; color: white; }

        .btn { background: var(--wa-green); border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; background: var(--wa-green); color: white; font-size: 20px; cursor: pointer; }

        /* Flag Page */
        #flag-page { padding: 40px 20px; text-align: center; overflow-y: auto; }
        .flag { width: 180px; height: 110px; background: #006a4e; margin: 20px auto; position: relative; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
        .circle { width: 55px; height: 55px; background: #f42a41; border-radius: 50%; }

        #call-ui { position: fixed; inset: 0; background: #0b141a; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="main-wrapper">
    <div id="login">
        <h2 style="color:var(--wa-green); margin-bottom:20px;">SECURITY NODE</h2>
        <input type="password" id="pw" placeholder="Enter Access Code" style="padding:15px; border-radius:10px; border:none; width:80%; text-align:center; background:#2a3942; color:#fff; margin-bottom: 20px;">
        <button onclick="auth()" class="btn" style="width: 80%; border-radius: 25px; height: 50px;">ACCESS</button>
    </div>

    <div id="app">
        <header>
            <div><b style="color:var(--wa-green);">Secure Hub</b><div id="p-status" style="font-size:11px; color:#8696a0;">Connecting...</div></div>
            <button onclick="makeCall()" style="background:none; border:none; font-size:22px; cursor:pointer;">üìû</button>
        </header>
        <div style="padding:10px; display:flex; gap:5px; background:rgba(0,0,0,0.2);">
            <input type="text" id="fid" placeholder="Friend's ID" style="flex:1; padding:8px; border-radius:5px; background:#111b21; border:none; color:white;">
            <button onclick="link()" class="btn" style="padding: 5px 15px;">Link</button>
        </div>
        <div id="chat-box"></div>
        <div class="input-bar">
            <button id="v-btn" class="circle-btn" style="background:#54656f;">üé§</button>
            <input type="text" id="m-in" placeholder="Message..." autocomplete="off">
            <button onclick="send()" class="circle-btn">üöÄ</button>
        </div>
    </div>

    <div id="flag-page">
        <h2 style="color:var(--wa-green);">Bangladesh Flag</h2>
        <div class="flag"><div class="circle"></div></div>
        <p style="color:#cfd8dc; line-height:1.6; text-align: justify; margin-top:20px;">
            The national flag of Bangladesh was adopted officially on 17 January 1972. It consists of a red disc on top of a dark green field. The red disc represents the sun rising over Bengal, and also the blood of those who died for the independence of Bangladesh. The green field stands for the lushness of the land of Bangladesh and its vitality.
        </p>
        <button onclick="location.reload()" class="btn" style="margin-top:40px; background:#2a3942;">Logout</button>
    </div>
</div>

<div id="call-ui">
    <div style="width:100px; height:100px; background:var(--wa-green); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px;">üë§</div>
    <h3 id="call-info" style="margin-top:20px;">Secure Call...</h3>
    <button onclick="hangup()" class="btn" style="background:#ea4335; margin-top:40px; padding:15px 40px; border-radius:30px;">End Call</button>
</div>

<script>
    let peer, conn, lStream, mediaRec, chunks = [], activeCall;
    const ring = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3');

    function auth() {
        const val = document.getElementById('pw').value;
        if(val === "1234") {
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            init();
        } else if(val === "4321") {
            document.getElementById('login').style.display = 'none';
            document.getElementById('flag-page').style.display = 'flex';
        } else {
            alert("Wrong Password!");
        }
    }

    function init() {
        let id = localStorage.getItem('s_pid') || Math.random().toString(36).substring(2,6).toUpperCase();
        localStorage.setItem('s_pid', id);
        peer = new Peer(id);
        peer.on('open', (myId) => {
            document.getElementById('p-status').innerText = "Your ID: " + myId;
            let last = localStorage.getItem('last_f');
            if(last) { document.getElementById('fid').value = last; link(); }
        });
        peer.on('connection', c => { conn = c; handleConn(); });
        peer.on('call', call => {
            ring.play();
            if(confirm("Incoming Call. Answer?")) {
                ring.pause();
                navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                    activeCall = call; lStream = s;
                    document.getElementById('call-ui').style.display = 'flex';
                    call.answer(s);
                    call.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
                    call.on('close', () => hangupUI());
                });
            } else { ring.pause(); }
        });
    }

    function link() {
        let tid = document.getElementById('fid').value.toUpperCase();
        if(tid) { localStorage.setItem('last_f', tid); conn = peer.connect(tid); handleConn(); }
    }

    function handleConn() {
        conn.on('open', () => { document.getElementById('p-status').innerText = "Secure Connection ‚úÖ"; });
        conn.on('data', d => {
            if(d.v) addAudio(d.v, 'fr');
            else addMsg(d, 'fr');
        });
        conn.on('close', () => { document.getElementById('p-status').innerText = "Disconnected ‚ùå"; });
    }

    function send() {
        let i = document.getElementById('m-in');
        if(conn && conn.open && i.value) {
            conn.send(i.value);
            addMsg(i.value, 'my');
            i.value = "";
        }
    }

    // Mic Voice logic
    const vBtn = document.getElementById('v-btn');
    ['mousedown', 'touchstart'].forEach(e => vBtn.addEventListener(e, (ev) => { ev.preventDefault(); startV(); }));
    ['mouseup', 'touchend'].forEach(e => vBtn.addEventListener(e, (ev) => { ev.preventDefault(); stopV(); }));

    async function startV() {
        try {
            lStream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec = new MediaRecorder(lStream);
            chunks = [];
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.start();
            vBtn.style.background = "#ea4335";
        } catch(e) { alert("Mic required!"); }
    }

    function stopV() {
        if(!mediaRec || mediaRec.state === "inactive") return;
        mediaRec.stop();
        vBtn.style.background = "#54656f";
        mediaRec.onstop = () => {
            const blob = new Blob(chunks, {type: 'audio/webm'});
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                if(conn && conn.open) {
                    conn.send({v: reader.result});
                    addAudio(reader.result, 'my');
                }
            };
            lStream.getTracks().forEach(t => t.stop());
        };
    }

    function makeCall() {
        let tid = document.getElementById('fid').value.toUpperCase();
        navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
            lStream = s;
            activeCall = peer.call(tid, s);
            document.getElementById('call-ui').style.display = 'flex';
            activeCall.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
            activeCall.on('close', () => hangupUI());
        });
    }

    function hangup() {
        if(activeCall) activeCall.close();
        if(lStream) lStream.getTracks().forEach(t => t.stop());
        ring.pause();
        hangupUI();
    }

    function hangupUI() { document.getElementById('call-ui').style.display = 'none'; }

    function addMsg(m, c) {
        let d = document.createElement('div'); d.className = `msg ${c}`; d.innerText = m;
        const cb = document.getElementById('chat-box');
        cb.appendChild(d); cb.scrollTop = cb.scrollHeight;
    }

    function addAudio(b, c) {
        let d = document.createElement('div'); d.className = `msg ${c}`;
        let a = document.createElement('audio'); a.controls = true; a.src = b; a.style.width = "180px";
        d.appendChild(a);
        const cb = document.getElementById('chat-box');
        cb.appendChild(d); cb.scrollTop = cb.scrollHeight;
    }
</script>

</body>
</html>
