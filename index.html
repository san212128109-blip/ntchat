<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Secret Hub Ultra</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; background-color: #0d1117; color: #c9d1d9; margin: 0; }
        .container { background: #161b22; padding: 20px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); text-align: center; width: 100%; max-width: 400px; display: none; margin-top: 10px; border: 1px solid #30363d; }
        #chat-box { width: 100%; height: 380px; border: 1px solid #30363d; border-radius: 12px; overflow-y: auto; padding: 15px; margin: 10px 0; background: #010409; display: flex; flex-direction: column; box-sizing: border-box; }
        .my-msg, .friend-msg { padding: 10px 14px; border-radius: 15px; margin: 5px 0; max-width: 80%; font-size: 14px; }
        .my-msg { align-self: flex-end; background: #1f6feb; color: white; border-radius: 15px 15px 0 15px; }
        .friend-msg { align-self: flex-start; background: #30363d; color: #58a6ff; border-radius: 15px 15px 15px 0; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; color: white; }
        .btn-call { background: #238636; }
        .btn-voice { background: #d29922; }
        .btn-send { background: #1f6feb; width: 100%; margin-top: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #30363d; border-radius: 8px; background: #0d1117; color: #58a6ff; outline: none; box-sizing: border-box; }
        audio { width: 100%; margin-top: 5px; height: 30px; }
    </style>
</head>
<body>

<div id="main-ui" class="container">
    <h3 style="color: #58a6ff; margin: 0;">üîí Ultra Blue Hub</h3>
    <p style="font-size: 12px;">ID: <span id="my-id-display" style="color:#58a6ff">...</span></p>
    <div id="status" style="font-size: 12px; margin-bottom: 5px;">Offline ‚è≥</div>

    <div class="controls">
        <button class="btn-call" onclick="startCall()">üìû Audio Call</button>
        <button id="voice-btn" class="btn-voice" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">üé§ Hold to Record</button>
    </div>

    <div id="chat-box"></div>
    <div id="typing-indicator" style="font-size:10px; color:gray; text-align:left;"></div>

    <input type="text" id="friend-id" placeholder="Bondhur ID boshao" style="margin-bottom: 5px;">
    <input id="message" placeholder="Message lekho..." onkeypress="handleEnter(event)">
    <button class="btn-send" onclick="sendMessage()">Send üöÄ</button>
</div>

<script>
    const MASTER_PASSWORD = "1234";
    let peer, conn, myStream, activeCall;
    let mediaRecorder, audioChunks = [];

    function checkAccess() {
        const pass = prompt("Access Key:");
        if (pass === MASTER_PASSWORD) {
            document.getElementById('main-ui').style.display = 'block';
            initPeer();
        } else {
            alert("Wrong!");
            document.body.innerHTML = "DENIED";
        }
    }

    function initPeer() {
        let myId = localStorage.getItem('blue_u_id') || Math.random().toString(36).substring(2, 6).toUpperCase();
        localStorage.setItem('blue_u_id', myId);
        peer = new Peer(myId);

        peer.on('open', (id) => {
            document.getElementById('my-id-display').innerText = id;
            autoConnect();
        });

        // Incoming Call Handler
        peer.on('call', (call) => {
            if (confirm("Incoming Audio Call... Receive?")) {
                navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                    call.answer(stream);
                    handleStream(call);
                });
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            setupHandlers();
        });
    }

    function autoConnect() {
        let tid = localStorage.getItem('blue_u_target');
        if (tid) {
            document.getElementById('friend-id').value = tid;
            conn = peer.connect(tid);
            setupHandlers();
        }
        setTimeout(autoConnect, 5000);
    }

    function setupHandlers() {
        conn.on('open', () => {
            document.getElementById('status').innerText = "Online ‚úÖ";
            document.getElementById('status').style.color = "#238636";
            localStorage.setItem('blue_u_target', conn.peer);
        });
        conn.on('data', (data) => {
            if (data.type === 'voice') {
                appendAudio(data.blob, 'friend-msg');
            } else {
                appendMessage(data, 'friend-msg');
            }
        });
    }

    // --- AUDIO CALL LOGIC ---
    function startCall() {
        const fId = document.getElementById('friend-id').value.toUpperCase();
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            const call = peer.call(fId, stream);
            handleStream(call);
        });
    }

    function handleStream(call) {
        call.on('stream', (remoteStream) => {
            const audio = document.createElement('audio');
            audio.srcObject = remoteStream;
            audio.play();
            alert("Call Connected!");
        });
    }

    // --- VOICE MESSAGE LOGIC ---
    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            document.getElementById('voice-btn').innerText = "üî¥ Recording...";
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        });
    }

    function stopRecording() {
        if (!mediaRecorder) return;
        mediaRecorder.stop();
        document.getElementById('voice-btn').innerText = "üé§ Hold to Record";
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const base64data = reader.result;
                if (conn && conn.open) {
                    conn.send({ type: 'voice', blob: base64data });
                    appendAudio(base64data, 'my-msg');
                }
            };
        };
    }

    function sendMessage() {
        const msg = document.getElementById('message').value;
        if (conn && conn.open && msg) {
            conn.send(msg);
            appendMessage(msg, 'my-msg');
            document.getElementById('message').value = "";
        }
    }

    function appendMessage(msg, cls) {
        const div = document.createElement('div');
        div.className = cls; div.innerText = msg;
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = 10000;
    }

    function appendAudio(blobData, cls) {
        const div = document.createElement('div');
        div.className = cls;
        const aud = document.createElement('audio');
        aud.controls = true; aud.src = blobData;
        div.appendChild(aud);
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = 10000;
    }

    function handleEnter(e) { if(e.key==='Enter') sendMessage(); }
    checkAccess();
</script>
</body>
</html>
