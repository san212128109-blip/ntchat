<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Secret Hub Ultra</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; background-color: #0d1117; color: #c9d1d9; margin: 0; }
        .container { background: #161b22; padding: 20px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); text-align: center; width: 100%; max-width: 400px; display: none; margin-top: 10px; border: 1px solid #30363d; }
        #chat-box { width: 100%; height: 350px; border: 1px solid #30363d; border-radius: 12px; overflow-y: auto; padding: 15px; margin: 10px 0; background: #010409; display: flex; flex-direction: column; box-sizing: border-box; }
        .my-msg, .friend-msg { padding: 10px 14px; border-radius: 15px; margin: 5px 0; max-width: 80%; font-size: 14px; }
        .my-msg { align-self: flex-end; background: #1f6feb; color: white; border-radius: 15px 15px 0 15px; }
        .friend-msg { align-self: flex-start; background: #30363d; color: #58a6ff; border-radius: 15px 15px 15px 0; }
        input { width: 100%; padding: 12px; border: 1px solid #30363d; border-radius: 8px; background: #0d1117; color: #58a6ff; outline: none; box-sizing: border-box; margin-bottom: 8px; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.3s; color: white; margin-bottom: 5px; }
        .btn-connect { background: #1f6feb; }
        .btn-send { background: #238636; }
        .btn-call { background: #d29922; }
        #status { font-size: 12px; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="main-ui" class="container">
    <h3 style="color: #58a6ff; margin: 0;">üîí Private Node</h3>
    <p style="font-size: 13px;">My ID: <span id="my-id-display" style="color:#58a6ff; font-weight:bold;">...</span></p>
    <div id="status">Disconnected ‚ùå</div>

    <div style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
        <input type="text" id="friend-id-input" placeholder="Bondhur ID likho">
        <button class="btn-connect" onclick="manualConnect()">Connect Now üîó</button>
    </div>

    <div id="chat-box"></div>
    <div id="typing-indicator"></div>

    <input id="message-input" placeholder="Message lekho..." onkeypress="handleEnter(event)">
    <button class="btn-send" onclick="sendMessage()">Send Message üöÄ</button>
    
    <div style="display: flex; gap: 5px; margin-top: 10px;">
        <button class="btn-call" onclick="startCall()" style="width: 50%;">üìû Call</button>
        <button id="voice-btn" style="background:#444; width: 50%;" onmousedown="startRecording()" onmouseup="stopRecording()">üé§ Voice</button>
    </div>
</div>

<script>
    const MASTER_PASSWORD = "1234";
    let peer, conn, mediaRecorder, audioChunks = [];

    function checkAccess() {
        const pass = prompt("Access Key:");
        if (pass === MASTER_PASSWORD) {
            document.getElementById('main-ui').style.display = 'block';
            startApp();
        } else {
            alert("Wrong Key!");
            document.body.innerHTML = "DENIED";
        }
    }

    function startApp() {
        let myId = localStorage.getItem('chat_id') || Math.random().toString(36).substring(2, 6).toUpperCase();
        localStorage.setItem('chat_id', myId);
        
        peer = new Peer(myId);

        peer.on('open', (id) => {
            document.getElementById('my-id-display').innerText = id;
            // Auto reconnect if target exists
            let lastTarget = localStorage.getItem('last_target');
            if (lastTarget) {
                document.getElementById('friend-id-input').value = lastTarget;
                connect(lastTarget);
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            setupHandlers();
        });

        peer.on('call', (call) => {
            if (confirm("Incoming Call... Answer?")) {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
                    call.answer(s);
                    call.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
                });
            }
        });
    }

    function manualConnect() {
        const id = document.getElementById('friend-id-input').value.toUpperCase();
        if (id) connect(id);
    }

    function connect(id) {
        localStorage.setItem('last_target', id);
        conn = peer.connect(id, { reliable: true });
        setupHandlers();
    }

    function setupHandlers() {
        conn.on('open', () => {
            document.getElementById('status').innerText = "Connected ‚úÖ";
            document.getElementById('status').style.color = "#238636";
        });
        conn.on('data', (data) => {
            if (data.type === 'voice') {
                appendAudio(data.blob, 'friend-msg');
            } else {
                appendMessage(data, 'friend-msg');
            }
        });
        conn.on('close', () => {
            document.getElementById('status').innerText = "Disconnected ‚ùå";
            document.getElementById('status').style.color = "#f85149";
        });
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        if (conn && conn.open && input.value) {
            conn.send(input.value);
            appendMessage(input.value, 'my-msg');
            input.value = "";
        }
    }

    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            mediaRecorder = new MediaRecorder(s);
            mediaRecorder.start();
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            document.getElementById('voice-btn').innerText = "üî¥ Rec...";
        });
    }

    function stopRecording() {
        if (!mediaRecorder) return;
        mediaRecorder.stop();
        document.getElementById('voice-btn').innerText = "üé§ Voice";
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/ogg' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                if (conn && conn.open) {
                    conn.send({ type: 'voice', blob: reader.result });
                    appendAudio(reader.result, 'my-msg');
                }
            };
        };
    }

    function startCall() {
        const id = document.getElementById('friend-id-input').value.toUpperCase();
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            const call = peer.call(id, s);
            call.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
        });
    }

    function appendMessage(m, c) {
        const d = document.createElement('div'); d.className = c; d.innerText = m;
        document.getElementById('chat-box').appendChild(d);
        document.getElementById('chat-box').scrollTop = 99999;
    }

    function appendAudio(b, c) {
        const d = document.createElement('div'); d.className = c;
        const a = document.createElement('audio'); a.controls = true; a.src = b;
        d.appendChild(a);
        document.getElementById('chat-box').appendChild(d);
        document.getElementById('chat-box').scrollTop = 99999;
    }

    function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
    checkAccess();
</script>
</body>
</html>
