<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Private Messenger</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --main-blue: #1f6feb; --dark-bg: #0b141a; --chat-bg: #0d1117; --incoming: #202c33; --outgoing: #005c4b; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--dark-bg); color: #e9edef; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        .app-container { width: 100%; max-width: 450px; display: none; flex-direction: column; height: 100%; background: var(--chat-bg); border-left: 1px solid #333; border-right: 1px solid #333; }
        
        header { background: #202c33; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        #status { font-size: 12px; color: #8696a0; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: contain; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 15px; position: relative; word-wrap: break-word; }
        .my-msg { align-self: flex-end; background: var(--outgoing); color: white; border-bottom-right-radius: 0; }
        .friend-msg { align-self: flex-start; background: var(--incoming); color: white; border-bottom-left-radius: 0; }
        .pending-tag { font-size: 10px; opacity: 0.6; display: block; margin-top: 4px; }

        .input-area { background: #202c33; padding: 10px; display: flex; align-items: center; gap: 8px; }
        input { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 8px; color: white; outline: none; }
        
        button { background: var(--main-blue); border: none; border-radius: 50%; width: 45px; height: 45px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        button:active { transform: scale(0.9); }

        #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; background: var(--main-blue); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .btn-end { background: #ea4335 !important; border-radius: 30px !important; width: auto !important; height: auto !important; padding: 15px 40px !important; margin-top: 30px; font-weight: bold; }
    </style>
</head>
<body>

<div id="call-screen">
    <div class="avatar">ðŸ‘¤</div>
    <h2 id="call-label">Calling...</h2>
    <button class="btn-end" onclick="endCall()">End Call</button>
</div>

<div id="main-ui" class="app-container">
    <header>
        <div>
            <div style="font-weight: bold; color: var(--main-blue);">Secret Chat</div>
            <div id="status">Connecting...</div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="startCall()" style="background:transparent; font-size: 20px; width:auto; height:auto;">ðŸ“ž</button>
            <span style="font-size: 11px; background: #333; padding: 4px 8px; border-radius: 4px;">ID: <b id="my-id-display">...</b></span>
        </div>
    </header>

    <div style="padding: 10px; background: #111b21; border-bottom: 1px solid #333;">
        <input type="text" id="friend-id-input" placeholder="Enter Friend's ID..." style="font-size: 12px; margin-bottom: 5px;">
        <button onclick="manualConnect()" style="border-radius: 5px; width: 100%; height: 30px; font-size: 12px;">Connect & Sync</button>
    </div>

    <div id="chat-box"></div>
    <div id="typing-indicator" style="padding: 5px 20px; font-size: 12px; color: #00a884; display: none;">Bondhu likhche...</div>

    <div class="input-area">
        <button id="voice-btn" style="background:#54656f;" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">ðŸŽ¤</button>
        <input id="message-input" placeholder="Type a message..." onkeypress="handleEnter(event)" oninput="sendTyping()">
        <button onclick="sendMessage()">ðŸš€</button>
    </div>
</div>

<script>
    const MASTER_PASSWORD = "1234";
    let peer, conn, currentStream, mediaRecorder, audioChunks = [], activeCall;
    let chatHistory = JSON.parse(localStorage.getItem('chats')) || [];
    let pendingQueue = JSON.parse(localStorage.getItem('pending')) || [];
    const ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3');
    ringtone.loop = true;

    function checkAccess() {
        const pass = prompt("Enter Access Key:");
        if (pass === MASTER_PASSWORD) {
            document.getElementById('main-ui').style.display = 'flex';
            startApp();
        } else {
            alert("Denied!"); document.body.innerHTML = "<h1>UNAUTHORIZED</h1>";
        }
    }

    function startApp() {
        let myId = localStorage.getItem('p_id') || Math.random().toString(36).substring(2, 6).toUpperCase();
        localStorage.setItem('p_id', myId);
        peer = new Peer(myId);

        peer.on('open', id => {
            document.getElementById('my-id-display').innerText = id;
            loadHistory();
            let last = localStorage.getItem('target');
            if (last) { document.getElementById('friend-id-input').value = last; manualConnect(); }
        });

        peer.on('connection', c => { conn = c; setupHandlers(); });

        peer.on('call', call => {
            ringtone.play();
            if (confirm("Incoming Audio Call... Answer?")) {
                ringtone.pause(); ringtone.currentTime = 0;
                navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
                    activeCall = call;
                    document.getElementById('call-screen').style.display = 'flex';
                    document.getElementById('call-label').innerText = "In Call";
                    call.answer(s);
                    call.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
                    call.on('close', () => endCallUI());
                });
            } else { ringtone.pause(); ringtone.currentTime = 0; }
        });
    }

    function manualConnect() {
        const id = document.getElementById('friend-id-input').value.toUpperCase();
        if (id) { localStorage.setItem('target', id); conn = peer.connect(id); setupHandlers(); }
    }

    function setupHandlers() {
        conn.on('open', () => {
            document.getElementById('status').innerText = "Online âœ…";
            flushPending();
        });
        conn.on('data', data => {
            if (data === "___TYPING___") showTyping();
            else if (data.type === 'voice') updateStorage(data.blob, 'friend-msg', true);
            else updateStorage(data, 'friend-msg');
        });
        conn.on('close', () => document.getElementById('status').innerText = "Offline â³");
    }

    // --- CALLING ---
    function startCall() {
        const id = document.getElementById('friend-id-input').value.toUpperCase();
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            currentStream = s;
            activeCall = peer.call(id, s);
            document.getElementById('call-screen').style.display = 'flex';
            activeCall.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
            activeCall.on('close', () => endCallUI());
        });
    }

    function endCall() {
        if (activeCall) activeCall.close();
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        ringtone.pause(); endCallUI();
    }

    function endCallUI() { document.getElementById('call-screen').style.display = 'none'; }

    // --- MESSAGING ---
    function sendMessage() {
        const input = document.getElementById('message-input');
        const msg = input.value.trim();
        if (!msg) return;

        if (conn && conn.open) {
            conn.send(msg);
            updateStorage(msg, 'my-msg');
        } else {
            pendingQueue.push(msg);
            localStorage.setItem('pending', JSON.stringify(pendingQueue));
            appendMessage(msg, 'my-msg', true);
        }
        input.value = "";
    }

    function sendTyping() { if (conn && conn.open) conn.send("___TYPING___"); }

    function showTyping() {
        const t = document.getElementById('typing-indicator');
        t.style.display = 'block';
        clearTimeout(window.tT);
        window.tT = setTimeout(() => t.style.display = 'none', 2000);
    }

    async function startRecording() {
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(currentStream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.start();
            document.getElementById('voice-btn').style.background = "#ea4335";
        } catch (e) { alert("Mic required!"); }
    }

    function stopRecording() {
        if (!mediaRecorder || mediaRecorder.state === "inactive") return;
        mediaRecorder.stop();
        document.getElementById('voice-btn').style.background = "#54656f";
        currentStream.getTracks().forEach(t => t.stop());
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/ogg' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                if (conn && conn.open) {
                    conn.send({ type: 'voice', blob: reader.result });
                    updateStorage(reader.result, 'my-msg', true);
                }
            };
        };
    }

    function updateStorage(msg, type, isVoice = false) {
        chatHistory.push({ msg, type, isVoice });
        localStorage.setItem('chats', JSON.stringify(chatHistory));
        isVoice ? appendAudio(msg, type) : appendMessage(msg, type);
    }

    function flushPending() {
        if (pendingQueue.length > 0 && conn.open) {
            pendingQueue.forEach(m => conn.send(m));
            chatHistory.push(...pendingQueue.map(m => ({msg: m, type: 'my-msg'})));
            pendingQueue = [];
            localStorage.setItem('pending', JSON.stringify(pendingQueue));
            localStorage.setItem('chats', JSON.stringify(chatHistory));
            loadHistory();
        }
    }

    function loadHistory() {
        document.getElementById('chat-box').innerHTML = '';
        chatHistory.forEach(c => c.isVoice ? appendAudio(c.msg, c.type) : appendMessage(c.msg, c.type));
        pendingQueue.forEach(m => appendMessage(m, 'my-msg', true));
    }

    function appendMessage(m, c, p) {
        const d = document.createElement('div');
        d.className = `msg ${c}`;
        d.innerHTML = m + (p ? '<span class="pending-tag">ðŸ•’ Pending</span>' : '');
        document.getElementById('chat-box').appendChild(d);
        document.getElementById('chat-box').scrollTop = 99999;
    }

    function appendAudio(b, c) {
        const d = document.createElement('div'); d.className = `msg ${c}`;
        const a = document.createElement('audio'); a.controls = true; a.src = b; a.style.width = "160px";
        d.appendChild(a);
        document.getElementById('chat-box').appendChild(d);
        document.getElementById('chat-box').scrollTop = 99999;
    }

    function handleEnter(e) { if(e.key==='Enter') sendMessage(); }
    checkAccess();
</script>
</body>
</html>
